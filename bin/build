#!/bin/bash

mkdir -p dist

FUNCS=$(ls functions)
MFUNCS=()

for m in $FUNCS; do
    ZIP="dist/$m.zip"
    if [ ! -e "${ZIP}" ]; then
        MFUNCS+=($m)
    else
        F=$(find functions/$m -type f \( -iname '*.ts' -o -iname '*.json' \) -newer $ZIP)
        if [ -n "$F" ]; then
            echo "Changes in $m"
            MFUNCS+=($m)
        fi
    fi
done

if [ -n "$MFUNCS" ]; then
    echo "[BUILD] typescript"
    tsc

    echo "[BUILD] apex"
    parallel --no-notice --bar apex build {} '>' dist/{}.zip ::: "${MFUNCS[@]}"
else
    echo "No changes"
fi
